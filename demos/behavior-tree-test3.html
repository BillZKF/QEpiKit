<html>
	<head>
		<link href="style.css" rel="stylesheet"></link>
		<link href="libs/wyard-style.css" rel="stylesheet"></link>
	</head>
	<body>
		<div class="bh-ctrl" id="control-panel">
			<h1>Behavior Tree Tests</h1>
			<form name="newNode" id="add-node">
			<div class="form-group">
				<label for="node-id">Node ID</label>
				<input id="node-id" name="id" class="form-control"></input>
			</div>
			<div class="form-group">
				<label for="node-type">Node Type</label>
				<select id="node-type" name="type" class="form-control">
					<option>root</option>
					<option>selector</option>
					<option>sequence</option>
					<option>parallel</option>
					<option>condition</option>
					<option>action</option>
				</select>
			</div>
			<div class="form-group">
				<label for="node-children">Children</label>
				<select id="node-children" name="children" class="form-control" multiple=true>
					<option value="null">none</option>
				</select>
			</div>
			<div class="form-group">
				<label for="node-cond">Condition</label>
				<select id="node-cond-prop" name="condition[key]" class="form-control">
				</select>
				<select id="node-cond-op" name="condition[check]" class="form-control">
					<option value="equalTo">Equals</option>
					<option value="notEqualTo">Does not Equal</option>
					<option value="gt">Less Than</option>
					<option value="gtEq">Less Than or Equal</option>
					<option value="lt">Greater Than</option>
					<option value="ltEq">Greater Than or Equal</option>
				</select>
				<input id="node-cond-value" name="condition[value]" class="form-control"></input>
			</div>
			<div class="btn btn-primary" onclick="addNode(newNode)">Add Node</div>
			</form>
		</div>
		<div id="diagram"></div>
		<div id="p1"></div>
		<link data-require="bootstrap-css@*" data-semver="3.2.0" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
		<script data-require="jquery@*" data-semver="2.1.1" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script data-require="jquery-ui@*" data-semver="1.10.4" src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
		<script src="../bower_components/d3/d3.min.js"></script>
		<script src="../bower_components/chance/chance.js"></script>
		<script src="../dist/behaviorTree.js"></script>
		<script src="libs/jquery_wyard.js"></script>
		<script src="bh-obesity-ex.js"></script>
		<script>
			var mouseDown = false;
			var t = 0;
			var summary;
			var init = function(){
				$("#diagram").on("mousedown", function(){mouseDown = true;});
				$("#diagram").on("mouseup", function(){mouseDown = false;});
				genPopulation(100);
				BHTree.history = [];
				BHTree.time = 0
				generateTimeData(BHTree, 1, 365 * 8, 365);

				getProperties(popData);
				summary = summarizeTimeData(BHTree.history, ['dead']);
				mouseDown = true;
				animate();
			};

			var row = 0;
			var col = 0;

			var generateTimeData = function(tree, step, limit, saveInterval){
				while(tree.time <= limit){
					var rem = tree.time % saveInterval;
					if(rem == 0){
						tree.data.map(function(d){ return d.time = tree.time});
						tree.history.push(jQuery.extend(true, {}, tree.data));
					}
					tree.update();
					tree.time += step;
				}
				return tree.history;
			}



			var addRelations = function(node, element){
				if(node.children !== null){
					row++;
					for (var c in node.children){
						addRelations(node.children[c], element);
						$(element).wyard("addRelation",{src_id : node.id + "_o", dest_id : node.children[c].id + "_i"});
					}
				}
			};

			var drawTreeByDepth = function(tree, element){
				//visit(tree.root, addEl);
				//addRelations(tree.root, element);
			};

			function animate() {
			   if(mouseDown){
				   //$('#diagram').wyard('drawRelations', {connectType : "vert"});
			   }
			   requestAnimationFrame(animate);
			}

			var addNode = function (node) {
				node = $(node).serializeArray();

				var nodeJSON = {
					"id" : node[0].value,
					"type" : node[1].value,
					"children" : node[2].value || null,
					"condition" : { "key": node[3].value || null, "check" : node[4].value || null, "value" : node[5].value},
					"action" : node[6].value || null
				}

				node = QKit.BehaviorTree.fromJSON([nodeJSON]);
				var el = {
					type : "vertConnects",
					header : "<div>" + node.id + "</div><div class='bh-tree-type'>" + node.type + "</div>",
					entityId : node.id
				};
				el.outputs = node.children === undefined ? undefined : true;
				$("#diagram").wyard('addEntity', el);
			};

			var ids = [];
			var visit = function(node, cb){
				cb(node);
				if (node.children !== null) {
					for (var c in node.children) {
						visit(node.children[c], cb);
					}
				}
			};

			var listIDs = function(node){
				ids.push(node.id);
			};

			var byID = function(node){
				if(node.id === id){
					return node;
				}
			}

			var getProperties = function(data){
				var props = [];
				for (var prop in data[0]){
					props.push(prop);
					$("#node-cond-prop").append(
						"<option>" + prop +  "</option>"
					);
				}

			}

			var setChildrenOptions = function(data){
				for(var i = 0; i < data.length; i++){
					$("#node-children").append(
						"<option>" + data[i] +  "</option>"
					);
				}
			};

			var summarizeTimeData = function(data, keys){
				var results = [];
				for(var step = 0; step < data.length; step++){
					results[step] = {};
					for(var d in data[step]){
						for(var key = 0; key < keys.length; key++){
							if (data[step][d][keys[key]] == true){
								results[step][keys[key]] = results[step][keys[key]] + 1 || 0;
							}
						}
					}
				}
				console.log(results);
				return results;
			}

var margin = {top: 20, right: 120, bottom: 20, left: 120},
width = 960 - margin.right - margin.left,
height = 500 - margin.top - margin.bottom;

var i = 0;

var tree = d3.layout.tree()
	.size([height, width]);

var diagonal = d3.svg.diagonal()
	.projection(function(d) { return [d.y, d.x]; });

var svg = d3.select("#diagram").append("svg")
	.attr("width", width + margin.right + margin.left)
	.attr("height", height + margin.top + margin.bottom)
  .append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var nodes = tree.nodes(BHTree.root)
	links = tree.links(nodes);

	// Normalize for fixed-depth.
nodes.forEach(function(d) { d.y = d.depth * 180; });

// Declare the nodes…
var node = svg.selectAll("g.node")
	.data(nodes, function(d) { return d.id || (d.id = ++i); });

// Enter the nodes.
var nodeEnter = node.enter().append("g")
	.attr("class", function(d){ return d.type})
	.attr("transform", function(d) {
		return "translate(" + d.y + "," + d.x + ")"; });

nodeEnter.append("circle")
	.attr("r", 10)


nodeEnter.append("text")
	.attr("x", function(d) {
		return d.children || d._children ? -13 : 13; })
	.attr("dy", ".35em")
	.attr("text-anchor", function(d) {
		return d.children || d._children ? "end" : "start"; })
	.text(function(d) { return d.type + " : " +d.id; })
	.style("fill-opacity", 1);

// Declare the links…
var link = svg.selectAll("path.link")
	.data(links, function(d) { return d.target.id; });

// Enter the links.
link.enter().insert("path", "g")
	.attr("class", "link")
	.attr("d", diagonal);


	init();
		</script>
	</body>

</html>
