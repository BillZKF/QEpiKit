<html>
	<head>
		<link href="style.css" rel="stylesheet"></link>
		<link href="libs/wyard-style.css" rel="stylesheet"></link>
	</head>
	<body>
		<div class="bh-ctrl" id="control-panel">
			<h1>Behavior Tree Tests</h1>
			<form name="newNode" id="add-node">
			<div class="form-group">
				<label for="node-id">Node ID</label>
				<input id="node-id" name="id" class="form-control"></input>
			</div>
			<div class="form-group">
				<label for="node-type">Node Type</label>
				<select id="node-type" name="type" class="form-control">
					<option>root</option>
					<option>selector</option>
					<option>sequence</option>
					<option>parallel</option>
					<option>condition</option>
					<option>action</option>
				</select>
			</div>
			<div class="form-group">
				<label for="node-children">Children</label>
				<select id="node-children" name="children" class="form-control" multiple=true>
					<option value="null">none</option>
				</select>
			</div>
			<div class="form-group">
				<label for="node-cond">Condition</label>
				<select id="node-cond-prop" name="condition[key]" class="form-control">
				</select>
				<select id="node-cond-op" name="condition[check]" class="form-control">
					<option value="equalTo">Equals</option>
					<option value="notEqualTo">Does not Equal</option>
					<option value="gt">Less Than</option>
					<option value="gtEq">Less Than or Equal</option>
					<option value="lt">Greater Than</option>
					<option value="ltEq">Greater Than or Equal</option>
				</select>
				<input id="node-cond-value" name="condition[value]" class="form-control"></input>
			</div>
			<div class="btn btn-primary" onclick="addNode(newNode)">Add Node</div>
			</form>
		</div>
		<div class="bh-tree" id="diagram"></div>
		<div id="p1"></div>
		<link data-require="bootstrap-css@*" data-semver="3.2.0" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"
		/>
		<script data-require="jquery@*" data-semver="2.1.1" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script data-require="d3@*" data-semver="3.4.6" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.6/d3.min.js"></script>
		<script data-require="jquery-ui@*" data-semver="1.10.4" src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
		<script src="../dist/behaviorTree.js"></script>
		<script src="libs/jquery_wyard.js"></script>
		<script src="bh-obesity-ex.js"></script>
		<script>
			var mouseDown = false;

			var popData = [
				{age:30, bmi: 25, doctorFq: 1 / 365, doctor: 0, exercise: 1},
				{age:70, bmi: 31, doctorFq: 3/ 365, doctor: 0, exercise: 1},
			];

			var loseWeight = function(person){ person.bmi = person.bmi - (0.1 * person.exercise);};
			var gainWeight = function(person){ person.bmi = person.bmi + 0.001;};
			var makeTime = function(person){ if(person.exercise < 7){seeDoctor(person); person.exercise += 2;  person.doctorFq *= 2;};};
			var makeDead = function(person){ person.dead = true;};
			var makeOld = function(person){ person.age += 1 / 365; person.doctor += person.doctorFq;};
			var makeSed = function(person){if(person.exercise > 0.1){ person.exercise = person.exercise - 0.01;} else {person.exercise = 0; gainWeight(person);}};
			var seeDoctor = function(person){person.doctor = 0;};


			var HeartAttack = new QKit.BTAction("are-they-at-great-risk-of-a-heart-attack", {key: "bmi", value :45, check : QKit.BehaviorTree.gtEq, data : popData}, makeDead);
			var HealthScare = new QKit.BTAction("health-scare", {key: "doctor", value :0.5, check : QKit.BehaviorTree.gtEq, data : popData}, makeTime);
			var NoContact = new QKit.BTAction("no-doctor-contact", {key: "exercise", value :3, check : QKit.BehaviorTree.ltEq, data : popData}, gainWeight);
			var SelectSedObese = new QKit.BTSelector("are-they-sedentary", [HeartAttack, HealthScare, NoContact]);
			var ActiveObese = new QKit.BTAction("are-they-active", {key: "exercise", value : 3, check : QKit.BehaviorTree.gtEq, data : popData}, loseWeight);
			var CondObese = new QKit.BTCondition("is-the-person-obese", {key: "bmi", value : 28, check : QKit.BehaviorTree.ltEq, data : popData});
			var SelectObese = new QKit.BTSelector("select-obese", [CondObese, ActiveObese, SelectSedObese]);
			var Age = new QKit.BTAction("is-person-an-adult", {key:"age", value : 21, check : QKit.BehaviorTree.gtEq, data : popData}, makeOld);
			var Sed = new QKit.BTAction("is-this-person-sedentary", {key:"age", value : 28, check : QKit.BehaviorTree.gtEq, data : popData}, makeSed);
			var Doctor = new QKit.BTAction("is-this-person-seeing-a-doctor", {key:"doctor", value : 1, check : QKit.BehaviorTree.gtEq, data : popData}, seeDoctor);
			var SequenceAge = new QKit.BTSequence("sequence-age", [Age, Sed, Doctor]);
			var Dead = new QKit.BTCondition("is-person-dead", {key:"dead", value : true, check : QKit.BehaviorTree.equalTo, data : popData});
			var Status = new QKit.BTSelector("select-status", [Dead, SequenceAge, SelectObese]);
			var Root = new QKit.BTRoot("root", [Status] );
			var BHTree =  new QKit.BehaviorTree(Root, popData);

			var t = 0;
			var main = function(){
				$("#diagram").on("mousedown", function(){mouseDown = true;});
				$("#diagram").on("mouseup", function(){mouseDown = false;});
				var html = "";
				while (t < 10 * 360){
					var printFQ = t % 365;
					if(printFQ == 0){
						html += "<h3>Y = " + t / 365 + "</h3>";
						for(var p in popData){
							html += "<div>";
							html += "<span>" + JSON.stringify(popData[p]) + ",</span>";
							html += "</div>";
						}
					}
					document.getElementById("p1").innerHTML = html;
					BHTree.update();
					t++;
				}
				drawTreeByDepth(BHTree, "#diagram");
				mouseDown = true;
				animate();
			};

			var row = 0;
			var col = 0;
			var getChildren = function(node, element){
				var e = {
					type : "vertConnects",
					header : "<div>" + node.id + "</div><div class='bh-tree-type'>" + node.type + "</div>",
					entityId : node.id
				}, el;
				e.outputs = node.children === undefined ? undefined : true;
				el = $(element).wyard('addEntity', e);
				el[0].style.top = row * 72 +"px";
				el[0].style.left = col * 250 +"px";	

				if(node.children !== null){
					row++;
					for (var c in node.children){
						col = c;
						getChildren(node.children[c], element);
					}
				}

			};

			var addRelations = function(node, element){
				if(node.children !== null){
					row++;
					for (var c in node.children){
						addRelations(node.children[c], element);
						$(element).wyard("addRelation",{src_id : node.id + "_o", dest_id : node.children[c].id + "_i"});
					}
				}
			};

			var drawTreeByDepth = function(tree, element){
				$(element).wyard();
				getChildren(tree.root, element);
				addRelations(tree.root, element);
			};

			function animate() {
			   if(mouseDown){
				   $('#diagram').wyard('drawRelations', {connectType : "vert"});
			   }
			   requestAnimationFrame(animate);
			}
			main();
		</script>
		<script src="script.js"></script></script>
	</body>

</html>