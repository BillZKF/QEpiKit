<html>
	<head>
		<link href="style.css" rel="stylesheet"></link>
		<link href="libs/wyard-style.css" rel="stylesheet"></link>
	</head>
	<body>
		<div class="bh-ctrl" id="control-panel">
			<h1>Behavior Tree Tests</h1>
			<form name="newNode" id="add-node">
			<div class="form-group">
				<label for="node-id">Node ID</label>
				<input id="node-id" name="id" class="form-control"></input>
			</div>
			<div class="form-group">
				<label for="node-type">Node Type</label>
				<select id="node-type" name="type" class="form-control">
					<option>root</option>
					<option>selector</option>
					<option>sequence</option>
					<option>parallel</option>
					<option>condition</option>
					<option>action</option>
				</select>
			</div>
			<div class="form-group">
				<label for="node-children">Children</label>
				<select id="node-children" name="children" class="form-control" multiple=true>
					<option value="null">none</option>
				</select>
			</div>
			<div class="form-group">
				<label for="node-cond">Condition</label>
				<select id="node-cond-prop" name="condition[key]" class="form-control">
				</select>
				<select id="node-cond-op" name="condition[check]" class="form-control">
					<option value="equalTo">Equals</option>
					<option value="notEqualTo">Does not Equal</option>
					<option value="gt">Less Than</option>
					<option value="gtEq">Less Than or Equal</option>
					<option value="lt">Greater Than</option>
					<option value="ltEq">Greater Than or Equal</option>
				</select>
				<input id="node-cond-value" name="condition[value]" class="form-control"></input>
			</div>
			<div class="btn btn-primary" onclick="addNode(newNode)">Add Node</div>
			</form>
		</div>
		<div class="bh-tree" id="diagram"></div>
		<div id="p1"></div>
		<link data-require="bootstrap-css@*" data-semver="3.2.0" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
		<script data-require="jquery@*" data-semver="2.1.1" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script data-require="jquery-ui@*" data-semver="1.10.4" src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
		<script src="../bower_components/d3/d3.min.js"></script>
		<script src="../bower_components/chance/chance.js"></script>
		<script src="../dist/behaviorTree.js"></script>
		<script src="libs/jquery_wyard.js"></script>
		<script src="bh-measles-ex.js"></script>
		<script>
			var mouseDown = false;
			var t = 0;
			var init = function(){
				$("#diagram").on("mousedown", function(){mouseDown = true;});
				$("#diagram").on("mouseup", function(){mouseDown = false;});
				genPopulation(100);
				var html = "";
				while (t < 30){
					var printFQ = t % 1;
					if(printFQ == 0){
						html += "<h3>D = " + t + "</h3><table><tr>";
						for (var prop in popProps){
							html += "<th>" + popProps[prop] + "</th>"
						}
						html += "</tr>";
						for(var p in popData){
							html += "<tr>";
							html += "<td>" + t + "</td>"
							for (var prop in popData[p]){
								html += "<td>" + popData[p][prop] + "</td>";
							}
							html += "</tr>";
						}
						html += "</table>";
					}
					document.getElementById("p1").innerHTML = html;
					BHTree.update();
					t++;
				}
				drawTreeByDepth(BHTree, "#diagram");
				getProperties(popData);
				visit(BHTree.root, listIDs);
				setChildrenOptions(ids);
				mouseDown = true;
				animate();
			};

			var row = 0;
			var col = 0;
			var getChildren = function(node, element){
				var e = {
					type : "vertConnects",
					header : "<div>" + node.id + "</div><div class='bh-tree-type'>" + node.type + "</div>",
					entityId : node.id
				}, el;
				e.outputs = node.children === undefined ? undefined : true;
				el = $(element).wyard('addEntity', e);
				el[0].style.top = row * 72 +"px";
				el[0].style.left = col * 250 +"px";

				if(node.children !== null){
					row++;
					for (var c in node.children){
						col = c;
						getChildren(node.children[c], element);
					}
				}

			};

			var addRelations = function(node, element){
				if(node.children !== null){
					row++;
					for (var c in node.children){
						addRelations(node.children[c], element);
						$(element).wyard("addRelation",{src_id : node.id + "_o", dest_id : node.children[c].id + "_i"});
					}
				}
			};

			var drawTreeByDepth = function(tree, element){
				$(element).wyard();
				getChildren(tree.root, element);
				addRelations(tree.root, element);
			};

			function animate() {
			   if(mouseDown){
				   $('#diagram').wyard('drawRelations', {connectType : "vert"});
			   }
			   requestAnimationFrame(animate);
			}


			var addNode = function (node) {
				node = $(node).serializeArray();

				var nodeJSON = {
					"id" : node[0].value,
					"type" : node[1].value,
					"children" : node[2].value || null,
					"condition" : { "key": node[3].value || null, "check" : node[4].value || null, "value" : node[5].value},
					"action" : node[6].value || null
				}

				node = QKit.BehaviorTree.fromJSON([nodeJSON]);
				var el = {
					type : "vertConnects",
					header : "<div>" + node.id + "</div><div class='bh-tree-type'>" + node.type + "</div>",
					entityId : node.id
				};
				el.outputs = node.children === undefined ? undefined : true;
				$("#diagram").wyard('addEntity', el);
			};

			var ids = [];
			var visit = function(node, cb){
				cb(node);
				if (node.children !== null) {
					for (var c in node.children) {
						visit(node.children[c], cb);
					}
				}
			};

			var listIDs = function(node){
				ids.push(node.id);
			};

			var byID = function(node){
				if(node.id === id){
					return node;
				}
			}

			var getProperties = function(data){
				var props = [];
				for (var prop in data[0]){
					props.push(prop);
					$("#node-cond-prop").append(
						"<option>" + prop +  "</option>"
					);
				}

			}

			var setChildrenOptions = function(data){
				for(var i = 0; i < data.length; i++){
					$("#node-children").append(
						"<option>" + data[i] +  "</option>"
					);
				}
			};

			init();
		</script>
	</body>

</html>
