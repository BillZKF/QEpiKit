<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <title>QEpiKit- Compartment Model Examples</title>
  <link href="style.css" rel="stylesheet"></link>
  <script src="../bower_components/d3/d3.min.js"></script>
  <script src="../dist/epi.js"></script>
  <script src="../dist/compartment.js"></script>
</head>

<body>
  <div id="results">
    <h1>QEpiKit - Compartment Model Examples</h1>
    <h2>SIR Model</h2>
    <p id="graph"></p>
    Time :
    <div id="time"></div>
    Suceptible :
    <div id="succeptible"></div>
    Infectious :
    <div id="infectious"></div>
    Removed :
    <div id="removed"></div>
    total :
    <div id="total"></div>
    Basic Reproductive Number :
    <div id="BRN"></div>
  </div>

  <script>
    var t = 0;
    var succeptible = new QKit.Compartment("succeptible", 0.999999);
    var infectious = new QKit.Compartment("infectious", 0.000001);
    var removed = new QKit.Compartment("removed", 0);
    var measPath = {
      transmissionRate: 0.15,
      recoveryRate: 0.1
    };
    var step = 1; // (measPath.transmissionRate + measPath.recoveryRate) * succeptible.pop;
    var measles = new QKit.CompartmentModel("measles", step, [succeptible, infectious, removed], measPath);
    succeptible.operation = function() {
      return -measles.transmissionRate * succeptible.pop * infectious.pop;
    };
    infectious.operation = function() {
      return measles.transmissionRate * succeptible.pop * infectious.pop - measles.recoveryRate * infectious.pop;
    };
    removed.operation = function() {
      return measles.recoveryRate * infectious.pop;
    };


    var svg = d3.select("p").append("svg").attr("height", 360).attr("width", 640).append("g");

    var x = d3.scale.linear()
      .domain([0, 300])
      .range([60, 640])

    var y = d3.scale.linear()
      .domain([measles.totalPop, 0])
      .range([60, 300])

    var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

    var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");

    svg.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0,300)")
      .call(xAxis);

    svg.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(60,0)")
      .call(yAxis);

    var curveDatas = [];
    var circles = [];

    function prepModel(model) {
      for (var c = 0; c < model.compartments.length; c++) {
        curveDatas[c] = [];
        circles[c] = svg.append("circle")
          .attr('cx', function() {
            return 0;
          })
          .attr('r', 7)
          .attr('class', model.compartments[c].name);
      }
    }


    function runModel(model) {
      if (t * model.step < 300) {
        var show = t % 60,
          cLen = model.compartments.length;
        svg.selectAll("path").remove();
        measles.run();
        if (show === 0) {
          document.getElementById("time").innerHTML = model.step * t;
          document.getElementById("succeptible").innerHTML = model.compartments[0].pop * 7900000;
          document.getElementById("infectious").innerHTML = model.compartments[1].pop * 7900000;
          document.getElementById("removed").innerHTML = model.compartments[2].pop * 7900000;
          document.getElementById("total").innerHTML = model.totalPop * 7900000;
          document.getElementById("BRN").innerHTML = model.basicReproductiveNumber;
        }
        curveFunc = d3.svg.line()
          .x(function(d) {
            return x(d.x);
          })
          .y(function(d) {
            return y(d.y);
          });


        for (var c = 0; c < cLen; c++) {
          circles[c].attr('transform', 'translate(' + x(model.step * t) + ',' + y(model.compartments[c].pop) + ')');

          curveDatas[c].push({
            x: t * step,
            y: model.compartments[c].pop
          });

          svg.append('path')
            .datum(curveDatas[c])
            .attr('class', 'line ' + model.compartments[c].name)
            .attr('d', curveFunc);
        }



        requestAnimationFrame(function() {
          runModel(measles)
        });
        t++;
      }
    }
    prepModel(measles);
    runModel(measles);
  </script>

  <div>
  </div>
  <script>
  </script>
</body>

</html>
